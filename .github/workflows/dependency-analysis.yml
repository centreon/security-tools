name: dependency-checks

on:
  pull_request:
  workflow_call:
    inputs:
      module_directory:
        description: 'Component path'
        required: false
        default: ""
        type: string

permissions:
  contents: read

env:
  minimum_package_age_hours: 1 # 168 # 7 days

jobs:
  dependency-scan:
    name: Run safe-chain analysis
    runs-on: ${{ github.repository_visibility != 'public' && 'centreon-security' || 'ubuntu-24.04' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup Pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22
          package-manager-cache: true

      - name: Install safe-chain
        run: |
          max_retries=5
          retry_delay=5
          
          for ((i=1; i<=max_retries; i++)); do
            if curl -fsSL https://github.com/AikidoSec/safe-chain/releases/latest/download/install-safe-chain.sh | sh -s -- --ci; then
              echo "Success on attempt $i"
              exit 0
            else
              echo "Attempt $i failed. Retrying in $retry_delay seconds..."
              sleep $retry_delay
            fi
          done
          
          echo "All $max_retries attempts failed."
          exit 1

        shell: bash

      - name: Check dependencies and managers
        run: |
          # Check override
          if [ "${{ vars.OVERRIDE_DEPENDENCY_SCAN }}" == "true" ]; then
            echo "[DEBUG] - Global scan override enabled"
            return 0
          elif [[ "${{ vars.OVERRIDE_PNPM_COMPLIANCE }}" == "true" ]]; then
            echo "[DEBUG] - PNPM scan override enabled"
            return 0
          fi

          # Check date
          current_timestamp=$(date +%s)
          DUE_DATE="${{ vars.OVERRIDE_DEPENDENCY_ENFORCEMENT_DATE }}"
          input_timestamp=$(date -d "$DUE_DATE" +%s)

          # Setup vars
          export SAFE_CHAIN_MINIMUM_PACKAGE_AGE_HOURS=${{ env.minimum_package_age_hours }}
          export SAFE_CHAIN_LOGGING="silent"
          ERROR_LOG="error_log.txt"
          FORCE_FAIL="false"
          ENFORCEMENT="false"
          if [ "$current_timestamp" -ge "$input_timestamp" ]; then
            echo "[DEBUG]: Deadline passed."
            ENFORCEMENT="true"
          fi

          function message_type() {
            if [ $ENFORCEMENT == "true" ]; then
              echo "[ERROR] : $1"  >> "$ERROR_LOG"
              FORCE_FAIL="true"
            else
              echo "[WARNING] : $1"  >> "$ERROR_LOG"
            fi
          }

          # Compare pnpm version used in lockfile
          function compare_version() {
            MIN_VERSION="10.0.0"
            LOC_VERSION=$(grep -E '^lockfileVersion:' "$LOC_TYPE" \
            | awk '{print $2}' \
            | tr -d "'\"")
            # Compare versions
            version_ge() {
              [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" = "$2" ]
            }
            if version_ge "$MIN_VERSION" "$LOC_VERSION"; then
              message_type "lockfileVersion $LOC_VERSION < $MIN_VERSION in $LOC_FILE"
            fi
          }

          # Move to module folder and find manifests
          MODULE_FOLDER="${{ inputs.module_directory }}" || ""
          if [[ -n "$MODULE_FOLDER" ]]; then
            cd $MODULE_FOLDER
          fi
          touch "$ERROR_LOG"
          echo "[INFO] - Find manifest files"
          DEP_FILES=$(find ./ -type f -name "package.json")

          # Scan node manifests
          for DEP_FILE in ${DEP_FILES[@]}; do
            DEP_DIR=$(dirname $DEP_FILE)
            echo "[INFO] - Scanning $DEP_FILE"
            LOC_FILES=$(find $DEP_DIR -type f -name "package-lock.json" -o -name "pnpm-lock.yaml" -o -name "yarn.lock")
            COUNT=0

            for LOC_FILE in ${LOC_FILES[@]}; do
              LOC_TYPE=$(basename $LOC_FILE)
              LOC_DIR=$(dirname $LOC_FILE)
              cd $LOC_DIR
              case $LOC_TYPE in
                "yarn.lock")
                  COUNT=$((COUNT+1))
                  message_type "Yarn is no longer allowed. Kindly replace the lockfile using PNPM : $LOC_FILE"
                  ;;
                "package-lock.json")
                  COUNT=$((COUNT+1))
                  message_type "NPM is no longer allowed. Kindly replace the lockfile using PNPM : $LOC_FILE"
                  ;;
                "pnpm-lock.yaml")
                  compare_version
                  corepack use pnpm@"$LOC_VERSION" 
                  pnpm install --frozen-lockfile --silent --safe-chain-logging=verbose
                  COUNT=$((COUNT+1))
                  ;;
                "*")
                  message_type "no lockfile found : $LOC_DIR"
                  ;;
              esac
              cd -
            done
            if [[ $COUNT -gt 1 ]]; then
              message_type "$COUNT lockfiles were found. Kindly keep only the lockfile generated with PNPM : $LOC_DIR"
            fi
          done

          if [ -s "$ERROR_LOG" ]; then
            cat "$ERROR_LOG"
            if [ "FORCE_FAIL" ==  "true" ]; then
              echo "[FATAL]: Breaking the run."
              exit 1
            fi
          else
            echo "[INFO] - OK nothing found"
          fi
        shell: bash

  dependency-blacklist:
    name: Run blacklist analysis
    runs-on: ${{ github.repository_visibility != 'public' && 'centreon-security' || 'ubuntu-24.04' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Run blacklist scan
        run: |
          if [ -f compromised-packages.txt ]; then rm -f compromised-packages.txt; fi
          wget https://raw.githubusercontent.com/centreon/security-tools/main/blacklist/compromised-packages.txt
          ERROR_LOG="error_log.txt"
          DEP_LIST="compromised-packages.txt"
          LOCKFILES=$(find ./ -name "pnpm-lock.yaml")

          function checkPnpmLockfile() {
            # Find dependency formated as
            # "name@version:"
            if grep -qF "$NAME@$VERSION" "$LOCKFILE"; then
              echo "$NAME:$VERSION was found in $LOCKFILE"
              echo "[ERROR] $NAME:$VERSION was found in $LOCKFILE" >> "$ERROR_LOG"
            else
                echo -n "."
            fi
          }

          function checkManifest() {
            COUNT=0
            echo "::info:: Testing manifest $LOCKFILE"
            manifest_type=$(basename "$LOCKFILE")
            while IFS=':' read -r NAME VERSION; do
              # ignore empty and commented lines
              [[ -z "${NAME// }" ]] && continue
              [[ "$NAME" =~ ^# ]] && continue
              #echo "DEBUG To check $NAME $VERSION"

              case "$manifest_type" in
                "pnpm-lock.yaml")
                  checkPnpmLockfile
                  ;;
                "yarn.lock")
                  echo "KO dependency manager not allowed"
                  ;;
                "package-lock.json")
                  echo "KO dependency manager not allowed"
                  ;;
                "*")
                  echo "KO manifest not managed"
                  exit 1
              esac
              COUNT=$((COUNT+1))
            done < "$DEP_LIST"
            echo "Scanned $COUNT IOC"
          }

          touch "$ERROR_LOG"
          for LOCKFILE in "${LOCKFILES[@]}"; do
            checkManifest "$LOCKFILE"
          done
          if [ -s "$ERROR_LOG" ]; then
            echo -e "[FATAL]: Breaking the run as following dependencies were found:"
            cat "$ERROR_LOG"
            exit 1
          else
            echo "OK nothing found"
          fi

        shell: bash
